<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Demo completa: Formulario + Tabla + DB</title>
  <style>
    body { font-family: system-ui; padding: 2rem; background:#fafafa; }
    form { display:grid; gap:10px; max-width:420px; background:#fff; padding:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    #status { width:220px; height:42px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; border-radius:8px; margin:1rem 0;}
    #status.ok{ background:#28a745;} #status.error{background:#dc3545;}
    .controls{ display:flex; gap:10px; align-items:center; margin:.5rem 0;}
    table { border-collapse: collapse; width:100%; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    th, td { border:1px solid #ddd; padding:8px; text-align:left;}
    th { background:#e9ecef; cursor:pointer; user-select:none; }
    th:hover{ background:#d6dee7; }
    .pager{ margin-top:10px; display:flex; gap:10px; align-items:center;}
    button, select, input[type="number"] { padding:6px 10px; }
    .btn { padding:6px 12px; border:1px solid #ccc; background:#fff; cursor:pointer; border-radius:6px;}
    .btn:hover { background:#f3f3f3; }
  </style>
</head>
<body>
  <h2>Formulario con subida de archivos</h2>
  <form id="form">
    <input name="nombre" placeholder="Nombre" required>
    <input name="email" placeholder="Email" type="email" required>
    <input name="edad" placeholder="Edad" type="number">
    <input name="archivo" type="file">
    <button class="btn">Enviar</button>
  </form>

  <div id="status">Listo</div>
  <p id="timer">Tiempo desde el último envío: 0s</p>

  <div class="controls">
    <input id="search" placeholder="Buscar por nombre, email o edad..." />
    <label>
      Filas por página:
      <select id="pageSize">
        <option>5</option>
        <option selected>10</option>
        <option>20</option>
        <option>50</option>
      </select>
    </label>
    <button id="exportCsv" class="btn">Exportar CSV</button>
  </div>

  <table id="tabla">
    <thead>
      <tr>
        <th data-col="id">ID</th>
        <th data-col="nombre">Nombre</th>
        <th data-col="email">Email</th>
        <th data-col="edad">Edad</th>
        <th data-col="archivo">Archivo</th>
        <th data-col="fecha">Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pager">
    <button id="prev" class="btn">Anterior</button>
    <span id="pageInfo"></span>
    <button id="next" class="btn">Siguiente</button>
  </div>

  <script>
    const form = document.getElementById('form');
    const tabla = document.querySelector('#tabla tbody');
    const statusBox = document.getElementById('status');
    const timerText = document.getElementById('timer');
    const search = document.getElementById('search');
    const pageSizeSel = document.getElementById('pageSize');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');
    const btnCsv = document.getElementById('exportCsv');

    let seconds = 0, timer;
    let registros = [];
    let sortCol = null, sortAsc = true;
    let page = 1, pageSize = parseInt(pageSizeSel.value,10);

    const startTimer = () => {
      clearInterval(timer);
      seconds = 0;
      timer = setInterval(() => {
        seconds++;
        timerText.textContent = `Tiempo desde el último envío: ${seconds}s`;
      }, 1000);
    };

    const load = async () => {
      const res = await fetch('/api/formularios');
      registros = await res.json();
      page = 1;
      render();
    };

    const getFilteredSorted = () => {
      const q = search.value.toLowerCase();
      let data = [...registros];
      if (q) {
        data = data.filter(r =>
          (r.nombre?.toLowerCase().includes(q)) ||
          (r.email?.toLowerCase().includes(q)) ||
          (r.edad?.toString().includes(q))
        );
      }
      if (sortCol) {
        data.sort((a,b)=>{
          const va = (a[sortCol] ?? '').toString().toLowerCase();
          const vb = (b[sortCol] ?? '').toString().toLowerCase();
          if(va<vb) return sortAsc?-1:1;
          if(va>vb) return sortAsc?1:-1;
          return 0;
        });
      }
      return data;
    };

    const render = () => {
      pageSize = parseInt(pageSizeSel.value,10);
      const data = getFilteredSorted();
      const total = data.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;
      const start = (page-1)*pageSize;
      const pageData = data.slice(start, start + pageSize);

      tabla.innerHTML = pageData.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.nombre ?? ''}</td>
          <td>${r.email ?? ''}</td>
          <td>${r.edad ?? ''}</td>
          <td>${r.archivo ? `<a href="/api/files/${r.archivo}" target="_blank">Descargar</a>` : ''}</td>
          <td>${r.fecha ? new Date(r.fecha).toLocaleString() : ''}</td>
        </tr>
      `).join('');

      pageInfo.textContent = `Página ${page} de ${totalPages} — ${total} registros`;
      btnPrev.disabled = page <= 1;
      btnNext.disabled = page >= totalPages;
    };

    form.onsubmit = async e => {
      e.preventDefault();
      statusBox.textContent = 'Enviando...';
      statusBox.className = '';
      const fd = new FormData(form);
      try {
        const res = await fetch('/api/formulario', { method:'POST', body:fd });
        const json = await res.json();
        if (json.ok) {
          statusBox.textContent = 'Éxito ✅';
          statusBox.className = 'ok';
          form.reset();
          await load();
          startTimer();
        } else {
          throw new Error(json.error || 'Error desconocido');
        }
      } catch (e) {
        statusBox.textContent = 'Error ❌';
        statusBox.className = 'error';
      }
    };

    search.addEventListener('input', ()=>{ page=1; render(); });
    pageSizeSel.addEventListener('change', ()=>{ page=1; render(); });
    btnPrev.addEventListener('click', ()=>{ if(page>1){ page--; render(); } });
    btnNext.addEventListener('click', ()=>{ page++; render(); });

    document.querySelectorAll('th[data-col]').forEach(th => {
      th.addEventListener('click', ()=>{
        const col = th.dataset.col;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = true; }
        render();
      });
    });

    btnCsv.addEventListener('click', ()=>{
      const data = getFilteredSorted();
      const headers = ['id','nombre','email','edad','archivo','fecha'];
      const rows = [headers.join(',')].concat(
        data.map(r => headers.map(h => {
          let v = r[h] ?? '';
          v = String(v).replace(/"/g,'""');
          return `"${v}"`;
        }).join(','))
      );
      const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'formularios.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    load();
    startTimer();
  </script>
</body>
</html>
